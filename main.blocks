<xml xmlns="https://developers.google.com/blockly/xml"><variables><variable id="^L)c|q}W=|mC(7q8bsZd">connected</variable><variable id="a13$L_8V!,8o$l]FhJU6">command</variable><variable id="Zq}f$IrGLJ3}{rp%,,VN">buzz</variable><variable id="ZUC8rsRK,P;*)[1Pj1(n">silent</variable><variable id="dMA-R-GK/Cr1$r@]`:I[">ping</variable></variables><comment id="iQJcPqf$27OV6afmmNqn" data="0" x="-419" y="4" h="238" w="362">MAIN

An audible buzzer, expected to paired with a Raspberry Pi "pegmon" alarm system.

Here we enable the bluetooth UART service (it's disabled by default) and set some control variables.</comment><comment id="l_aW83t~]]Ai3t,//#@7" data="1" x="0" y="0" h="238.4444580078125" w="332.99993896484375">A function to clear the display, used when the device starts and after an alarm has been cleared. Just keep one LED lit, to indicate we're "awake" and have power. 

Each time clear is called the lit LED changes position - this helps the user gain confidence the device is being communicated with 

We also reset the silent flag.</comment><comment id="whz5ET3|j2Hev9LWj_j@" data="2" x="376" y="-4" h="267" w="318">If button "B" is pressed we set a control variable that silences the audible part of the alarm.

This essentially allows us to "acknowledge" the alarm, silencing it. The visual part of the alarm continues to operate until a command is received from pegmon.</comment><comment id="8Kp@bcva)PY9Af!|VnLz" x="844" y="-4" h="206" w="393">The alarm bacjground task. Here we make a sound every 20 seconds or so and continuously flash an exclamation mark if "buzz" is true.

We don't make a sound if "silent" is true, which is true if the user has hit button "B"</comment><comment id="2$imQ[mnlm|R)p#l6Hf7" x="1356" y="5" h="152" w="293">The "ping" background task - it just blanks the display for a short period of time (if "buzz" is false)</comment><comment id="m$/m?((K;WY7!II`cX5v" data="3" x="-419" y="719" h="336" w="462">When the pegmon device connects, which is usually brief for the transmission of one command, we sit reading the UART, collecting characters that form a command up to a ":" delimiter.

If the "command" is "buzz" we simply set the "buzz" boolean which cause the background task handling the alarm to run. We cease the alarm when if we get the "nobuzz" command and ignore everything else.

Th "ping" command causes the idle screen to go blank for a short period of time (if "buzz" is false).</comment><block type="pxt-on-start" id="GxpvG-AC50?KrZk#(%i|" x="-418" y="263"><statement name="HANDLER"><block type="bluetooth_start_uart_service" id="F4?!eAQ_M$HGRsg?0!.z"><next><block type="synth_set_volume" id="WS{c4Vj/X|~c}0z9a=Nq"><value name="volume"><shadow type="math_number_minmax" id="-a{=[.E}5U{uR8nf;ddY"><mutation min="0" max="255" label="Number" precision="0"/><field name="SLIDER">255</field></shadow></value><next><block type="variables_set" id="NTy*KAmw3WuW+e0]9DJX"><field name="VAR" id="^L)c|q}W=|mC(7q8bsZd">connected</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="GnM!ZdJ@38_iYM9GsT%9"><field name="BOOL">FALSE</field></block></value><next><block type="variables_set" id="LsIIfSknp%bU8A77sH,^"><field name="VAR" id="Zq}f$IrGLJ3}{rp%,,VN">buzz</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="`]ZF]M5BD)fcL!4cYjUj"><field name="BOOL">FALSE</field></block></value><next><block type="variables_set" id="X/nez4MzQfXQ_6-^{H:c"><field name="VAR" id="dMA-R-GK/Cr1$r@]`:I[">ping</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="{!4CrxM%HFqL~s[;d{p4"><field name="BOOL">FALSE</field></block></value><next><block type="function_call" id="1|*#}|jJE?u+(Yi,hxe:"><mutation name="clear" functionid="gc_!]?m:=slG{Vf9G-#_"/></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type="function_definition" id="kpFbz`C/C~5%|*9L3|S," x="5" y="247"><mutation name="clear" functionid="gc_!]?m:=slG{Vf9G-#_"/><field name="function_name">clear</field><statement name="STACK"><block type="variables_set" id="7X7=GC~v?KK${W2pndb,"><field name="VAR" id="ZUC8rsRK,P;*)[1Pj1(n">silent</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id=",QqC;;F-eMNC0fU`!|0G"><field name="BOOL">FALSE</field></block></value><next><block type="device_show_leds" id="/q(M;=x@SXd3NZb+VmY$"><field name="LEDS">`
        . . . . . 
        . . . . . 
        . . . . . 
        . . . . . 
        . . . . .
        `</field><next><block type="device_plot_brightness" id="0v^,o`x76*lt|,(=3FEQ"><value name="x"><shadow type="math_number_minmax" id="PRo5qzr5PQ;a2If?M,TE"><mutation min="0" max="4" label="X" precision="1"/><field name="SLIDER">0</field></shadow><block type="device_random" id="?UgPT(r}Qlqu=lz[GJ8H"><value name="min"><shadow type="math_number" id="o42w=OLL:PYDuK#//w(N"><field name="NUM">0</field></shadow></value><value name="limit"><shadow type="math_number" id="/mFozT+|#RFA~{twcb?P"><field name="NUM">4</field></shadow></value></block></value><value name="y"><shadow type="math_number_minmax" id="8MT=`E8F??BuJ:]ejCj5"><mutation min="0" max="4" label="Y" precision="1"/><field name="SLIDER">0</field></shadow><block type="device_random" id="hgy#^s`rFJcVE$2.vV|m"><value name="min"><shadow type="math_number" id="-.1YkE@tE9FxLB+B(@//"><field name="NUM">0</field></shadow></value><value name="limit"><shadow type="math_number" id="|d^apX/~#!O1TMIByhp+"><field name="NUM">4</field></shadow></value></block></value><value name="brightness"><shadow type="math_number_minmax" id="2(7mTMJlLLPceq[kY(NA"><mutation min="0" max="255" label="Brightness" precision="0"/><field name="SLIDER">4</field></shadow></value></block></next></block></next></block></statement></block><block type="control_in_background" id="uWkqPR]!MTV;CX:|_%!]" x="841" y="232"><comment pinned="false" h="80" w="160" relx="10" rely="10">The alarm loop - operating continuously in the background.

Here, if "buzz" is True we start the alarm sequence, which consists of making a warning sound and then flashing a visual symbol (an exclamation mark). We continue to do this, checking the "buzz" variable regularly, until "buzz" is false.

If "silent" is True (which is set by pressing button "B" during the alarm sequence) we silence the audible part of the alarm but continue the visual part.

We increase the brightness of the LEDs which are dimmed again (by the "clear()" function) when the alarm ceases.</comment><statement name="HANDLER"><block type="device_while" id="zE#~bHLnj}zK6=-Q-|{F"><value name="COND"><shadow type="logic_boolean" id="ErP,^DwsWJ)q^|1h1)Rd"><field name="BOOL">TRUE</field></shadow></value><statement name="DO"><block type="controls_if" id="WgI3}pOO)TW^/yob]!JR"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="variables_get" id="x7*p#i9P?G?%pFd3]=W{"><field name="VAR" id="Zq}f$IrGLJ3}{rp%,,VN">buzz</field></block></value><statement name="DO0"><block type="device_set_brightness" id="5F%F%uw5W=J.0aI(zdMR"><value name="value"><shadow type="math_number_minmax" id="0k1RZehJ)KdDV,x49:Z~"><mutation min="0" max="255" label="Number" precision="0"/><field name="SLIDER">32</field></shadow></value><next><block type="device_while" id="|UG$HJMQz3_o?d^-#HhF"><value name="COND"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="variables_get" id="D1B6f-@U[n|rv2jtrO=~"><field name="VAR" id="Zq}f$IrGLJ3}{rp%,,VN">buzz</field></block></value><statement name="DO"><block type="controls_if" id="+|dMFNCJ{8$6c{xyq@hN"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="rh#p^M0V5J[%|YEJm!BY"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="variables_get" id="GTMYW+mD0_Smd?leK)=N"><field name="VAR" id="ZUC8rsRK,P;*)[1Pj1(n">silent</field></block></value></block></value><statement name="DO0"><block type="SoundExpression_play" id="AC1gL,/{4Fvwtmf.793N"><field name="this">soundExpression.giggle</field></block></statement><next><block type="controls_repeat_ext" id="WtT[~q2g-O$5T[bi1@Gs"><value name="TIMES"><shadow type="math_whole_number" id="5apk@k4OlSsVd|LRw%.Y"><field name="NUM">20</field></shadow></value><statement name="DO"><block type="controls_if" id="%`6+eYPS{k0]M=+w6aTw"><mutation else="1"/><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="variables_get" id="@{-LuDegyqehE-g{!wv}"><field name="VAR" id="Zq}f$IrGLJ3}{rp%,,VN">buzz</field></block></value><statement name="DO0"><block type="device_show_leds" id="~4_4:vU.0PAfGv|~iA^G"><field name="LEDS">`
        . . # . . 
        . . # . . 
        . . # . . 
        . . . . . 
        . . # . .
        `</field><next><block type="device_pause" id="1c/hb-rOFj(tH)~cwsGb"><value name="pause"><shadow type="timePicker" id="^.Nwm^X5i=[)%8Yx+R!^"><field name="ms">500</field></shadow></value><next><block type="device_show_leds" id="09{q))I{PxLVoLkO.Li8"><field name="LEDS">`
        . . . . . 
        . . . . . 
        . . . . . 
        . . . . . 
        . . . . .
        `</field><next><block type="device_pause" id="@03LVzMAsZ-VG39{z[$$"><value name="pause"><shadow type="timePicker" id="zv%Ig(yeckWV3pm1`1}i"><field name="ms">500</field></shadow></value></block></next></block></next></block></next></block></statement><statement name="ELSE"><block type="break_keyword" id="iK1-Dp{ad3=7ORf~j5HM"/></statement></block></statement></block></next></block></statement><next><block type="function_call" id="YJB~fOQB=t@9tU^5r#a^"><mutation name="clear" functionid="gc_!]?m:=slG{Vf9G-#_"/></block></next></block></next></block></statement><next><block type="device_pause" id="sDk,[F(mEN.Yog7+};5e"><value name="pause"><shadow type="timePicker" id="bHcF-SZ|=^Zc7%M:joR]"><field name="ms">1000</field></shadow></value></block></next></block></statement></block></statement></block><block type="control_in_background" id="yEOiL^dn?znh^z!*4XeU" x="1351" y="223"><statement name="HANDLER"><block type="device_while" id="BMqv$j(f#Hi%)$r7jH8B"><value name="COND"><shadow type="logic_boolean" id="Q~pQG`!s3Px?nm]nqsC)"><field name="BOOL">TRUE</field></shadow></value><statement name="DO"><block type="controls_if" id="ZK,_%SI,j=%/m![kdSt_"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="variables_get" id="S~B)B]9n~6gkwBm@5/po"><field name="VAR" id="dMA-R-GK/Cr1$r@]`:I[">ping</field></block></value><statement name="DO0"><block type="controls_if" id=":lCxM4jg+Hn.`e/Lo:DB"><value name="IF0"><shadow type="logic_boolean" id="l0lA.:kckvx@IVe[xOTf" disabled="true"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="E}O?Bf??*hLaS/eEqCzU"><value name="BOOL"><block type="variables_get" id="YCMDt#|9VOV?cZ]5%rD!"><field name="VAR" id="Zq}f$IrGLJ3}{rp%,,VN">buzz</field></block></value></block></value><statement name="DO0"><block type="device_show_leds" id="yiIsNty%Ok)sfPHx+5O$"><field name="LEDS">`
        . . . . . 
        . . . . . 
        . . . . . 
        . . . . . 
        . . . . .
        `</field><next><block type="device_pause" id="jeNIr+UYas~o|mEuQy/2"><value name="pause"><shadow type="timePicker" id="|D$qNtD8]-Dqdx_n|M`o"><field name="ms">1000</field></shadow></value><next><block type="function_call" id="`$L|S5],8m7[|q6fHL}J"><mutation name="clear" functionid="gc_!]?m:=slG{Vf9G-#_"/></block></next></block></next></block></statement><next><block type="variables_set" id="XE;9JE)|Ob1yDTn[(pP4"><field name="VAR" id="dMA-R-GK/Cr1$r@]`:I[">ping</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="tq`?7nDOQU!3]2Q8#=kx"><field name="BOOL">FALSE</field></block></value></block></next></block></statement><next><block type="device_pause" id="X}GLo~Q9#8C~Qdib)hyB"><value name="pause"><shadow type="timePicker" id="8:XRt[[aDjrTAcseO=S="><field name="ms">1000</field></shadow></value></block></next></block></statement></block></statement></block><block type="device_button_event" id="f5ACG{TSOM?DbCGsVMk$" x="381" y="307"><field name="NAME">Button.B</field><statement name="HANDLER"><block type="controls_if" id="SBJEZU*C4}rIXgw[lB?y"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="variables_get" id="@?N,jwpN6.C0x;;BR}3Q"><field name="VAR" id="Zq}f$IrGLJ3}{rp%,,VN">buzz</field></block></value><statement name="DO0"><block type="variables_set" id="r=!#,gqJ@I1X8/1Rh})X"><field name="VAR" id="ZUC8rsRK,P;*)[1Pj1(n">silent</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="xJTjr3czwK?F-jT|[Ey+"><field name="BOOL">TRUE</field></block></value></block></statement></block></statement></block><block type="bluetooth_on_connected" id="B-V5Xh3I$2!Az2FMMPor" x="-419" y="1112"><comment pinned="false" h="80" w="160" relx="10" rely="10">When pegmon disconnects from us we simply set connected to false. This really has no effect at the moment, We handle it simply to indicate we know we can handle it.</comment><data>0;1;2;3</data><statement name="HANDLER"><block type="variables_set" id="ohFABg_-i_$m|78NgN,Z"><field name="VAR" id="^L)c|q}W=|mC(7q8bsZd">connected</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="7H!!`;iI8OKAhBbM0?VZ"><field name="BOOL">TRUE</field></block></value><next><block type="device_while" id="G-J5:5w[l6!k7#@abByH"><value name="COND"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="variables_get" id="Kt15F+,QFPF*fM8~-1U3"><field name="VAR" id="^L)c|q}W=|mC(7q8bsZd">connected</field></block></value><statement name="DO"><block type="variables_set" id="o$F1x0mvS}N~/RtR|!np"><field name="VAR" id="a13$L_8V!,8o$l]FhJU6">command</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="bluetooth_uart_read" id="N!!#P0.+`yPpNWK_+TpM"><value name="del"><shadow type="serial_delimiter_conv" id=":LL}]]9xKT}kR6@p`?If"><field name="del">Delimiters.Colon</field></shadow></value></block></value><next><block type="controls_if" id="ei|t2!C*hSZ`=s-{zWVY"><mutation else="1"/><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_compare" id="T|+MaLMy}H[:%IMOmIH$"><field name="OP">EQ</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="4*.O4BZgr8)JGuN(TecV"><field name="VAR" id="a13$L_8V!,8o$l]FhJU6">command</field></block></value><value name="B"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="text" id="]vSnm/:8td#1cKbFE~au"><field name="TEXT">buzz</field></block></value></block></value><statement name="DO0"><block type="variables_set" id="m(}Cs;I{E;SpP_N2(cnr"><field name="VAR" id="Zq}f$IrGLJ3}{rp%,,VN">buzz</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="(9hrc(JwqF@2dIuO}ZHH"><field name="BOOL">TRUE</field></block></value></block></statement><statement name="ELSE"><block type="controls_if" id="ZzoO9p|1G/s?Uh)o`YfM"><mutation else="1"/><value name="IF0"><shadow type="logic_boolean" id="mG{duEI[En!1GbIxSo^0"><field name="BOOL">TRUE</field></shadow><block type="logic_compare" id="H]{A6I*D}g+9Pdvhek[d"><field name="OP">EQ</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="/Fd%/+x;TQ/Z-Jq)l)YU"><field name="VAR" id="a13$L_8V!,8o$l]FhJU6">command</field></block></value><value name="B"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="text" id="Nu[D)!1tVu;-r@NS]Ny!"><field name="TEXT">nobuzz</field></block></value></block></value><statement name="DO0"><block type="variables_set" id="U?vA[+4sgWgA)DpH$+`]"><field name="VAR" id="Zq}f$IrGLJ3}{rp%,,VN">buzz</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="n8LxBX)uoJ!AC+yK|Nsb"><field name="BOOL">FALSE</field></block></value></block></statement><statement name="ELSE"><block type="controls_if" id="VSe608H2fua.)HLih1;e"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_compare" id="fv]p*)*P70FjQapL6[n("><field name="OP">EQ</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="v)H4X5{Bh?|g/,6RZ)_m"><field name="VAR" id="a13$L_8V!,8o$l]FhJU6">command</field></block></value><value name="B"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="text" id="(J{Am_y3M:I3Ew!4%]sv"><field name="TEXT">ping</field></block></value></block></value><statement name="DO0"><block type="variables_set" id="[W_/^.M8mKzwT/`97n5:"><field name="VAR" id="dMA-R-GK/Cr1$r@]`:I[">ping</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="?rAO;c4,GSwX^f:1YDO5"><field name="BOOL">TRUE</field></block></value></block></statement></block></statement></block></statement></block></next></block></statement></block></next></block></statement></block><block type="bluetooth_on_disconnected" id="p!8Q43hk._`VKQ6sAhJ?" x="272" y="1108"><statement name="HANDLER"><block type="variables_set" id="rNP#KKJ-Y~rk:fka#rFF"><field name="VAR" id="^L)c|q}W=|mC(7q8bsZd">connected</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="u7TY!Kn6V:m@rTPSiwCq"><field name="BOOL">FALSE</field></block></value></block></statement></block></xml>